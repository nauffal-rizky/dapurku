{% extends '../layout/base.html' %} {% block content %}
<section class="cartpage">
  <article class="content">
    <!-- UPDATE ADDRESS POPUP (outside main form) -->
    <div class="popup-prompt hidden">
      <div class="popup-box">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
          class="svg-20"
          id="close-popup"
        >
          <path
            fill-rule="evenodd"
            d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z"
            clip-rule="evenodd"
          />
        </svg>
        <span>Perbarui Alamat</span>
        <form method="POST">
          {% csrf_token %}
          <div class="inputs">
            <div class="input-box">
              <label for="inputStreet">Jalan</label>
              <input
                type="text"
                name="street"
                id="inputStreet"
                placeholder="Jalan..."
                required
                autocomplete="off"
              />
            </div>
            <div class="input-box">
              <label for="inputHouseNo">Nomor Rumah</label>
              <input
                type="text"
                name="house_no"
                id="inputHouseNo"
                placeholder="Nomor Rumah..."
                autocomplete="off"
              />
            </div>
            <div class="input-box">
              <label for="inputRtRw">RT/RW</label>
              <input
                type="text"
                name="rtrw"
                id="inputRtRw"
                placeholder="RT/RW..."
                autocomplete="off"
              />
            </div>
            <div class="input-box">
              <label for="inputKelurahan">Kelurahan</label>
              <input
                type="text"
                name="kelurahan"
                id="inputKelurahan"
                placeholder="Kelurahan/Desa..."
                required
                autocomplete="off"
              />
            </div>
            <div class="input-box">
              <label for="inputKecamatan">Kecamatan</label>
              <input
                type="text"
                name="kecamatan"
                id="inputKecamatan"
                placeholder="Kecamatan..."
                required
                autocomplete="off"
              />
            </div>
            <div class="input-box">
              <label for="inputKota">Kota</label>
              <input
                type="text"
                name="city"
                id="inputKota"
                placeholder="Kota/Kabupaten..."
                required
                autocomplete="off"
              />
            </div>
            <div class="input-box">
              <label for="inputProvince">Provinsi</label>
              <input
                type="text"
                name="province"
                id="inputProvince"
                placeholder="Provinsi..."
                required
                autocomplete="off"
              />
            </div>
            <div class="input-box">
              <label for="inputPostalCode">Kode Pos</label>
              <input
                type="text"
                name="postal_code"
                id="inputPostalCode"
                placeholder="Kode Pos..."
                required
                autocomplete="off"
              />
            </div>
          </div>
          <button type="submit">Simpan Perubahan</button>
        </form>
      </div>
    </div>

    <!-- BACK BUTTON -->
    <a href="{% url 'products' %}" class="back-btn">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
        class="svg-25"
      >
        <path
          fill-rule="evenodd"
          d="M7.28 7.72a.75.75 0 0 1 0 1.06l-2.47 2.47H21a.75.75 0 0 1 0 1.5H4.81l2.47 2.47a.75.75 0 1 1-1.06 1.06l-3.75-3.75a.75.75 0 0 1 0-1.06l3.75-3.75a.75.75 0 0 1 1.06 0Z"
          clip-rule="evenodd"
        />
      </svg>
      Kembali ke halaman depan
    </a>

    <!-- HEADER -->
    <div class="desc">
      <span
        >Ada <span class="amount">sekian</span> produk di keranjang belanja
        Anda</span
      >
      <label class="select-all">
        <input type="checkbox" name="" />
        <div class="checkbox">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
            class="size-6"
          >
            <path
              fill-rule="evenodd"
              d="M19.916 4.626a.75.75 0 0 1 .208 1.04l-9 13.5a.75.75 0 0 1-1.154.114l-6-6a.75.75 0 0 1 1.06-1.06l5.353 5.353 8.493-12.74a.75.75 0 0 1 1.04-.207Z"
              clip-rule="evenodd"
            />
          </svg>
        </div>
        Pilih semua
      </label>
    </div>

    <!-- PRODUCTS -->
    <div class="cart-products">
      {% for item in cart_items %}
      <div class="product-info">
        <input type="hidden" name="cart_item_id" value="{{ item.id }}" />
        <label>
          <input
            type="checkbox"
            name="selected_items"
            value="{{ item.id }}"
            checked
          />
          <div class="checkbox">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
              class="size-6"
            >
              <path
                fill-rule="evenodd"
                d="M19.916 4.626a.75.75 0 0 1 .208 1.04l-9 13.5a.75.75 0 0 1-1.154.114l-6-6a.75.75 0 0 1 1.06-1.06l5.353 5.353 8.493-12.74a.75.75 0 0 1 1.04-.207Z"
                clip-rule="evenodd"
              />
            </svg>
          </div>
        </label>
        {% if item.product.image %}
        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" />
        {% else %}
        <img src="/static/img/1.jpg" alt="default image" />
        {% endif %}
        <div class="desc">
          <span>{{ item.product.name }}</span>
          <span>{{ item.product.price|floatformat:0 }}/pcs</span>
        </div>
        <div class="stock">
          <div class="circle"></div>
          <span>Stok: {{ item.product.stock }}</span>
        </div>
        <div class="quantity">
          <button type="button" class="minus-btn">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
              class="svg-20"
            >
              <path
                fill-rule="evenodd"
                d="M4.25 12a.75.75 0 0 1 .75-.75h14a.75.75 0 0 1 0 1.5H5a.75.75 0 0 1-.75-.75Z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
          <span>{{ item.quantity }}</span>
          <button type="button" class="plus-btn">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
              class="svg-20"
            >
              <path
                fill-rule="evenodd"
                d="M12 3.75a.75.75 0 0 1 .75.75v6.75h6.75a.75.75 0 0 1 0 1.5h-6.75v6.75a.75.75 0 0 1-1.5 0v-6.75H4.5a.75.75 0 0 1 0-1.5h6.75V4.5a.75.75 0 0 1 .75-.75Z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </div>
        <span class="total-price">Rp {{ item.total_price|floatformat:0 }}</span>
        <!-- DELETE BUTTON -->
        <button type="button" class="delete-btn" data-item-id="{{ item.id }}">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
            class="svg-20"
          >
            <path
              fill-rule="evenodd"
              d="M16.5 4.478v.227a48.816 48.816 0 0 1 3.878.512.75.75 0 1 1-.256 1.478l-.209-.035-1.005 13.07a3 3 0 0 1-2.991 2.77H8.084a3 3 0 0 1-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 0 1-.256-1.478A48.567 48.567 0 0 1 7.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 0 1 3.369 0c1.603.051 2.815 1.387 2.815 2.951Zm-6.136-1.452a51.196 51.196 0 0 1 3.273 0C14.39 3.05 15 3.684 15 4.478v.113a49.488 49.488 0 0 0-6 0v-.113c0-.794.609-1.428 1.364-1.452Zm-.355 5.945a.75.75 0 1 0-1.5.058l.347 9a.75.75 0 1 0 1.499-.058l-.346-9Zm5.48.058a.75.75 0 1 0-1.498-.058l-.347 9a.75.75 0 0 0 1.5.058l.345-9Z"
              clip-rule="evenodd"
            />
          </svg>
        </button>
      </div>
      {% empty %}
      <p class="no-products">Keranjang belanja Anda kosong.</p>
      {% endfor %}
    </div>

    <!-- ADDRESS SELECTION (inside main form) -->
    <div class="address-selection">
      <span>Alamat Pengiriman:</span>
      {% if user.addresses.exists %} {% for addr in addresses %}
      <label class="address-option">
        <input
          type="radio"
          name="selected_address"
          value="{{ addr.id }}"
          checked
          required
        />
        <div class="address-details">
          <span>{{ addr.street }}</span>, <span>{{ addr.house_no }}</span>,
          <span>{{ addr.rtrw }}</span>, <span>{{ addr.kelurahan }}</span>,
          <span>{{ addr.kecamatan }}</span>, <span>{{ addr.city }}</span>,
          <span>{{ addr.province }}</span>,
          <span>{{ addr.postal_code }}</span>
        </div>
        <a href="/address/manage/{{ addr.id }}">Ubah</a>
      </label>
      {% endfor %} {% else %}
      <p class="no-address">
        Anda belum memiliki alamat.
        <a href="/address/manage">Tambahkan alamat</a> terlebih dahulu.
      </p>
      {% endif %}
    </div>

    <!-- SUBTOTAL & BUTTONS (inside main form) -->
    <div class="spanBtn">
      <span>Sub Total: <span class="subtotal underline-text">0</span></span>
      <div class="btn-container">
        <a href="{% url 'products' %}">Kembali belanja</a>
        <a href="{% url "order_list" %}" class="pesan-btn"> Pesan </a>
      </div>
    </div>

    <!-- ERROR MANAGEMENT -->
    {% if messages %}
    <div class="error-list">
      {% for message in messages %}
      <span class="{% if message.tags %}{{ message.tags }}{% endif %}"
        >{{ message }}</span
      >
      {% endfor %}
    </div>
    {% endif %}
  </article>
</section>
{% endblock %} {% block script %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const products = document.querySelectorAll(
      ".cartpage .content .cart-products .product-info",
    );
    const amount = document.querySelector(".cartpage .content .desc .amount");
    amount.textContent = products.length;

    const selectAllCheckbox = document.querySelector(".select-all input");
    selectAllCheckbox.checked = true;
    const itemCheckboxes = document.querySelectorAll(
      ".product-info label input",
    );

    /* CHECKBOXES */
    selectAllCheckbox.addEventListener("change", () => {
      itemCheckboxes.forEach((checkbox) => {
        checkbox.checked = selectAllCheckbox.checked;
      });
    });

    itemCheckboxes.forEach((checkbox) => {
      checkbox.checked = true;
      checkbox.addEventListener("change", () => {
        if (!checkbox.checked) {
          selectAllCheckbox.checked = false;
        } else {
          const allChecked = Array.from(itemCheckboxes).every(
            (cb) => cb.checked,
          );
          selectAllCheckbox.checked = allChecked;
        }
      });
    });

    /* QUANTITY */
    const quantitySpans = document.querySelectorAll(".quantity span");
    const totalPriceSpans = document.querySelectorAll(".total-price");
    const unitPriceSpans = document.querySelectorAll(
      ".desc span:nth-of-type(2)",
    ); // Fixed selector to match your HTML

    /* FORMAT RUPIAH */
    totalPriceSpans.forEach((span) => {
      const priceText = span.textContent.replace("Rp ", "").replace(/\./g, "");
      const priceValue = parseInt(priceText);
      span.textContent = `Rp ${priceValue.toLocaleString("id-ID")}`;
    });

    unitPriceSpans.forEach((span) => {
      const priceText = span.textContent.replace("/pcs", "").replace(/\./g, "");
      const priceValue = parseInt(priceText);
      span.textContent = `${priceValue.toLocaleString("id-ID")}/pcs`;
    });

    const subtotalSpan = document.querySelector(".subtotal");

    /* +- BTNS */
    const minusButtons = document.querySelectorAll(
      ".quantity button:first-of-type",
    );
    minusButtons.forEach((button, index) => {
      button.addEventListener("click", () => {
        let quantity = parseInt(quantitySpans[index].textContent);
        if (quantity <= 1) return;
        quantity--;
        quantitySpans[index].textContent = quantity;

        // Get the item ID from the hidden input
        const itemId = button
          .closest(".product-info")
          .querySelector('input[name="cart_item_id"]').value;

        // Update via AJAX
        fetch(`/cartpage/update/${itemId}/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
              .value,
          },
          body: JSON.stringify({ quantity: quantity }),
        }).then((response) => {
          if (!response.ok) {
            console.error("Failed to update quantity");
            // Optionally revert quantity on error
          }
        });

        // Update total price
        const unitPriceText = unitPriceSpans[index].textContent
          .replace(/\./g, "")
          .replace("/pcs", "");
        const unitPrice = parseInt(unitPriceText);
        const totalPrice = unitPrice * quantity;
        totalPriceSpans[index].textContent =
          `Rp ${totalPrice.toLocaleString("id-ID")}`;
        updateSubtotal();
      });
    });

    const plusButtons = document.querySelectorAll(
      ".quantity button:last-of-type",
    );
    plusButtons.forEach((button, index) => {
      button.addEventListener("click", () => {
        let quantity = parseInt(quantitySpans[index].textContent);

        // If quantity <= stock then continue increasing the quantity
        const stockText = button
          .closest(".product-info")
          .querySelector(".stock span").textContent;
        const stockValue = parseInt(stockText.replace("Stok: ", ""));
        if (quantity >= stockValue) {
          alert("Stok tidak mencukupi.");
          return;
        } else {
          quantity++;
        }
        quantitySpans[index].textContent = quantity;

        // Get the item ID from the hidden input
        const itemId = button
          .closest(".product-info")
          .querySelector('input[name="cart_item_id"]').value;

        // Update via AJAX
        fetch(`/cartpage/update/${itemId}/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
              .value,
          },
          body: JSON.stringify({ quantity: quantity }),
        }).then((response) => {
          if (!response.ok) {
            console.error("Failed to update quantity");
            // Optionally revert quantity on error
          }
        });

        // Update total price
        const unitPriceText = unitPriceSpans[index].textContent
          .replace(/\./g, "")
          .replace("/pcs", "");
        const unitPrice = parseInt(unitPriceText);
        const totalPrice = unitPrice * quantity;
        totalPriceSpans[index].textContent =
          `Rp ${totalPrice.toLocaleString("id-ID")}`;
        updateSubtotal();
      });
    });

    /* UPDATE SUBTOTAL */
    const updateSubtotal = () => {
      let subtotal = 0;
      totalPriceSpans.forEach((span) => {
        const priceText = span.textContent
          .replace("Rp ", "")
          .replace(/\./g, "");
        subtotal += parseInt(priceText);
      });
      subtotalSpan.textContent = `Rp ${subtotal.toLocaleString("id-ID")}`;
    };
    updateSubtotal();

    /* STOCK */
    const stocks = document.querySelectorAll(".stock");
    stocks.forEach((stock) => {
      const stockText = stock.textContent.replace("Stok: ", "");
      const stockValue = parseInt(stockText);
      const circle = stock.querySelector(".circle");
      if (stockValue <= 5) {
        circle.classList.add("almost_run_out");
      } else {
        circle.classList.add("stocked");
      }
    });

    /* DELETE BUTTONS (NEW: Handle via AJAX) */
    document.querySelectorAll(".delete-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const itemId = btn.dataset.itemId;
        if (confirm("Hapus item ini dari keranjang?")) {
          fetch(`/cartpage/delete/${itemId}/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": document.querySelector(
                "[name=csrfmiddlewaretoken]",
              ).value,
            },
          }).then((response) => {
            if (response.ok) {
              // Remove the product from DOM
              btn.closest(".product-info").remove();
              // Update product count and subtotal
              const updatedProducts = document.querySelectorAll(
                ".cart-products .product-info",
              );
              amount.textContent = updatedProducts.length;
              updateSubtotal();
            } else {
              alert("Gagal menghapus item.");
            }
          });
        }
      });
    });
  });
</script>
{% endblock %}
