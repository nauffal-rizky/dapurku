{% extends '../layout/base.html' %} {% block content %}
<section class="profile">
  <article class="content">
    <a href="{% url 'frontpage' %}" class="back-btn"
      ><i class="fa-solid fa-arrow-left"></i>Kembali ke halaman depan</a
    >
    <div class="details">
      <div class="img-box">
        {% if user.profile_image %}
        <img
          src="{{ user.profile_image.url }}"
          alt="Profile Image"
          width="150"
          height="150"
        />
        {% else %}
        <img
          src="/static/1.jpg"
          alt="Default Avatar"
          width="150"
          height="150"
        />
        {% endif %}
      </div>
      <div class="detail-info">
        <div class="desc">
          <div class="head">
            <h1 id="lblUsername">{{ user.username }}</h1>
            {% if user.is_umkm %}
            <span class="umkm" style="color: green">UMKM</span>
            {% else %}
            <span style="color: blue">Customer</span>
            {% endif %}
          </div>
          <div class="col">
            <div class="row">
              <span>Email:</span>
              <span class="underline-text" id="lblEmail">{{ user.email }}</span>
            </div>
            <div class="row">
              <span>Phone Number:</span>
              <span class="underline-text" id="lblPhone"
                >{{ user.phone_number }}</span
              >
            </div>
            <div class="row">
              <span>Status:</span>
              <span class="underline-text" id="lblStatus"
                >{{ user.get_user_status_display }}</span
              >
            </div>
            <div class="row">
              <span>Deskripsi:</span>
              <span class="underline-text" id="lblDescription">
                {{ user.description }}
              </span>
            </div>
          </div>
          <button id="editBtn">Ubah Profil</button>
        </div>
        {% if messages %}
        <div class="message-box">
          {% for message in messages %}
          <div class="alert {{ message.tags }}">{{ message }}</div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>

    <div class="edit-profile hidden">
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <i class="fa-solid fa-xmark"></i>
        <span>Ubah Profil</span>
        <div class="main-details">
          <div class="img-box">
            {% if product.image %} {% if form.instance.image %}
            <img src="{{ form.instance.image.url }}" alt="product-img" />
            {% else %}
            <img src="/static/1.jpg" alt="default-img" />
            {% endif %} {% else %}
            <img src="/static/1.jpg" alt="{{ product.name }}" />
            {% endif %}
            <label for="profile_image">
              <i class="fa-solid fa-pen"></i>
              <input
                type="file"
                id="profile_image"
                name="profile_image"
                autocomplete="off"
              />
            </label>
          </div>
          <div class="inputs">
            <div class="input-container">
              <div class="input-box">
                {{ form.username.label_tag }} {{ form.username }}
              </div>
              <div class="input-box">
                {{ form.email.label_tag }} {{ form.email }}
              </div>
              <div class="input-box">
                {{ form.phone_number.label_tag }} {{ form.phone_number }}
              </div>
              <div class="input-box">
                <label for="input_status">Status</label>
                <select name="user_status" id="input_status" class="custom-select">
                  <option value="active" {% if user.user_status == 'active' %}selected{% endif %}>Active</option>
                  <option value="inactive" {% if user.user_status == 'inactive' %}selected{% endif %}>Inactive</option>
                  <option value="suspended" {% if user.user_status == 'suspended' %}selected{% endif %}>Suspended</option>
                </select>
                <i class="fa-solid fa-chevron-down"></i>
              </div>
            </div>
            <div class="input-box description-box">
              {{ form.description.label_tag }} {{ form.description }}
            </div>
          </div>
        </div>
        <button id="saveBtn" type="submit">Simpan</button>
      </form>
    </div>

    {% if user.is_umkm %}
    <div class="my-products">
      <div class="head">
        <h2>Produk Saya</h2>
        <a href="{% url 'add_product' %}">Tambah Produk</a>
      </div>
      <div class="product-list">
        {% for product in products %}
        <div class="product-item">
          <span class="category {{ product.category }}"
            >{{ product.category }}</span
          >
          <div class="image">
            {% if product.image %} {% if form.image.value %}
            <img src="{{ form.image.value.url }}" alt="product-img" />
            {% else %}
            <img src="/static/1.jpg" alt="product-img" />
            {% endif %} {% else %}
            <img src="/static/1.jpg" alt="{{ product.name }}" />
            {% endif %}
            <div class="overlay">{{ product.description }}</div>
          </div>
          <div class="desc">
            <span class="nama">{{ product.name }}</span>
            <span class="harga">Rp{{ product.price }}</span>
            <p>{{ product.umkm_user_id.username }}</p>
            <span>
              <i class="fa-solid fa-star"></i>
              {{ product.rating }} | {{ product.sold }} terjual
            </span>
            <div class="btn-container">
              <a href="{% url 'edit_product' product.pk %}" class="edit-btn"
                >Edit</a
              >
              <a href="{% url 'delete_product' product.pk %}" class="delete-btn"
                >Hapus</a
              >
              <a href="{% url 'product_detail' product.pk %}" class="detail-btn"
                >Detail</a
              >
            </div>
          </div>
        </div>
        {% empty %}
        <p class="no-products">Belum ada produk yang tersedia.</p>
        {% endfor %}
      </div>
    </div>

    <section class="dashboard">
      <h2>Analisis UMKM</h2>
      <div class="metrics">
        <div class="metric-card">
          <h3>Total Produk</h3>
          <p>{{ dashboard.total_products }}</p>
        </div>
        <div class="metric-card">
          <h3>Total Penjualan</h3>
          <p>{{ dashboard.total_sales }}</p>
        </div>
        <div class="metric-card">
          <h3>Total Pendapatan</h3>
          <p>Rp{{ dashboard.total_revenue|floatformat:2 }}</p>
        </div>
        <div class="metric-card">
          <h3>Rata-rata Rating</h3>
          <p>{{ dashboard.average_rating }}</p>
        </div>
      </div>

      <canvas id="topProductsChart" width="400" height="200"></canvas>
    </section>
    {% else %}
    <section class="dashboard">
      <h2>Aktivitas Belanja Saya</h2>
      <div class="metrics">
        <div class="metric-card">
          <h3>Total Pesanan</h3>
          <p>{{ dashboard.total_orders }}</p>
        </div>
        <div class="metric-card">
          <h3>Total Barang Dibeli</h3>
          <p>{{ dashboard.total_items }}</p>
        </div>
        <div class="metric-card">
          <h3>Total Pengeluaran</h3>
          <p>Rp{{ dashboard.total_spent|floatformat:2 }}</p>
        </div>
        <div class="metric-card">
          <h3>Kategori Favorit</h3>
          <p>{{ dashboard.favorite_category }}</p>
        </div>
      </div>
    </section>
    {% endif %}

    <a href="/logout" class="logout-btn"
      >Logout<i class="fa-solid fa-right-from-bracket"></i
    ></a>
  </article>
</section>
{% endblock %} {% block script %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    {% if user.is_umkm and dashboard.top_products %}
    const ctx = document.getElementById('topProductsChart');
    const topProducts = {{ dashboard.top_products|json_script:"top-products" }};
    const data = JSON.parse(document.getElementById('top-products').textContent);

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: data.map(p => p.name),
        datasets: [{
          label: 'Total Terjual',
          data: data.map(p => p.sold),
          borderWidth: 1
        }]
      },
      options: {
        scales: { y: { beginAtZero: true } }
      }
    });
    {% endif %}

    const editProfileForm = document.querySelector(".edit-profile");
    const exitForm = document.querySelector(".edit-profile i");
    const editButton = document.querySelector("#editBtn");
    const saveButton = document.querySelector("#saveBtn");

    if (!editButton || !saveButton || !editProfileForm) return;

    const toggleEditFormVisibility = (e) => {
      editProfileForm.classList.toggle("hidden");
    };

    window.addEventListener("click", (e) => {
      if (
        e.target === exitForm ||
        e.target === saveButton ||
        e.target === editButton ||
        (e.target === editProfileForm &&
          e.target !== editProfileForm.querySelector("form"))
      ) {
        editProfileForm.classList.toggle("hidden");
      }
    });

    const profileImagePreview = document.querySelector(
      ".edit-profile .img-box img"
    );
    const inputProfileImage = document.querySelector("#profile_image");
    const profileImage = document.querySelector(".details .img-box img");

    inputProfileImage.addEventListener("change", function () {
      const file = this.files[0];

      if (!file) {
        profileImagePreview.src = "";
        profileImagePreview.style.display = "none";
        return;
      }

      if (!file.type.startsWith("image/")) {
        alert("Please select a valid image file.");
        this.value = "";
        profileImagePreview.src = "";
        profileImagePreview.style.display = "none";
        return;
      }

      const objectURL = URL.createObjectURL(file);

      profileImagePreview.src = objectURL;
      profileImagePreview.style.display = "block";

      profileImagePreview.onload = () => {
        URL.revokeObjectURL(objectURL);
      };

      profileImagePreview.onerror = () => {
        profileImagePreview.src = "";
        profileImagePreview.style.display = "none";
        alert("Failed to load the selected image.");
      };
    });

    const inputs = document.querySelectorAll(".input-box > input");

    const MAX_LENGTHS = {
      username: 10,
      email: 30,
      phone_number: 13,
      password1: 12,
      password2: 12,
      description: 150,
    };

    const validators = {
      username: (value) =>
        value.length <= MAX_LENGTHS.username ||
        `Maksimal ${MAX_LENGTHS.username} karakter`,
      email: (value) =>
        value.includes("@") && value.length <= MAX_LENGTHS.email
          ? true
          : `Email harus valid dan maksimal ${MAX_LENGTHS.email} karakter`,
      phone_number: (value) =>
        (value.length <= MAX_LENGTHS.phone_number && /^\d+$/.test(value)) ||
        "Nomor telepon harus berupa angka",
      password: (value) =>
        value.length <= MAX_LENGTHS.password ||
        `Maksimal ${MAX_LENGTHS.password} karakter`,
      description: (value) =>
        value.length <= MAX_LENGTHS.description ||
        `Maksimal ${MAX_LENGTHS.description} karakter`,
    };

    const validateInput = (input) => {
      const fieldName = input.id.replace("input_", "");
      const value = input.value.trim();
      const validator = validators[fieldName];

      if (validator) {
        const result = validator(value);
        if (result !== true) {
          input.setCustomValidity(result);
          input.reportValidity();
          return false;
        } else {
          input.setCustomValidity("");
          return true;
        }
      }
      return true;
    };

    inputs.forEach((input) => {
      input.addEventListener("input", () => {
        const field = input.id.replace("input_", "");
        const maxLength = MAX_LENGTHS[field];
        if (maxLength && input.value.length > maxLength) {
          input.value = input.value.slice(0, maxLength);
        }
      });

      input.addEventListener("blur", () => {
        validateInput(input);
      });
    });

    const inputUsername = document.querySelector("#input_username");
    const inputEmail = document.querySelector("#input_email");
    const inputPhoneNumber = document.querySelector("#input_phone_number");
    const inputUserStatus = document.querySelector("#input_status");
    const inputUserDescription = document.querySelector("#input_description");

    const lblUsername = document.querySelector("#lblUsername");
    const lblEmail = document.querySelector("#lblEmail");
    const lblPhone = document.querySelector("#lblPhone");
    const lblStatus = document.querySelector("#lblStatus");
    const lblDescription = document.querySelector("#lblDescription");

    const form = document.querySelector(".edit-profile form");
    form.addEventListener("submit", () => {
      profileImage.src = profileImagePreview.src || "/static/1.jpg";
      lblUsername.textContent = inputUsername.value;
      lblEmail.textContent = inputEmail.value;
      lblPhone.textContent = inputPhoneNumber.value;
      lblStatus.textContent = inputUserStatus.value;
      lblDescription.textContent = inputUserDescription.value;
    });
  });
</script>
{% endblock %}
