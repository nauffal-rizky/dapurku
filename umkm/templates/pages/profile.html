{% extends '../layout/base.html' %} {% block content %}
<section class="profile">
  <article class="content">
    <a href="{% url 'products' %}" class="back-btn">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
        class="svg-25"
      >
        <path
          fill-rule="evenodd"
          d="M7.28 7.72a.75.75 0 0 1 0 1.06l-2.47 2.47H21a.75.75 0 0 1 0 1.5H4.81l2.47 2.47a.75.75 0 1 1-1.06 1.06l-3.75-3.75a.75.75 0 0 1 0-1.06l3.75-3.75a.75.75 0 0 1 1.06 0Z"
          clip-rule="evenodd"
        />
      </svg>
      Kembali ke halaman depan</a
    >

    <!-- USER DETAILS -->
    <div class="details">
      <div class="img-box">
        {% if user.profile_image %}
        <img
          src="{{ user.profile_image.url }}"
          alt="Profile Image"
          width="150"
          height="150"
        />
        {% else %}
        <img
          src="/static/img/1.jpg"
          alt="Default Avatar"
          width="150"
          height="150"
        />
        {% endif %}
      </div>
      <div class="detail-info">
        <div class="desc">
          <div class="head">
            <h1 id="lblUsername">{{ user.username }}</h1>
            {% if user.is_umkm %}
            <span class="umkm" style="color: green">UMKM</span>
            {% else %}
            <span style="color: blue">Customer</span>
            {% endif %}
          </div>
          <div class="col">
            <div class="row">
              <span>Email:</span>
              <span class="underline-text" id="lblEmail">{{ user.email }}</span>
            </div>
            <div class="row">
              <span>Phone Number:</span>
              <span class="underline-text" id="lblPhone"
                >{{ user.phone_number }}</span
              >
            </div>
            <div class="row">
              <span>Status:</span>
              <span class="underline-text" id="lblStatus"
                >{{ user.get_user_status_display }}</span
              >
            </div>
            <div class="row">
              <span>Deskripsi:</span>
              <span class="underline-text" id="lblDescription">
                {{ user.description }}
              </span>
            </div>
          </div>
          <button id="editBtn">Ubah Profil</button>
        </div>
        {% if messages %}
        <div class="message-box">
          {% for message in messages %}
          <div class="alert {{ message.tags }}">{{ message }}</div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>

    {% if user.is_umkm %}
    <!-- UMKM PRODUCTS -->
    <div class="my-products">
      <div class="head">
        <h2 class="underline-text">Produk Saya</h2>
        <a href="{% url 'add_product' %}">Tambah Produk</a>
      </div>
      <div class="product-list">
        {% for product in products %}
        <div class="product-item">
          <span class="category {{ product.category }}"
            >{{ product.category }}</span
          >
          <div class="image">
            {% if product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}" />
            {% else %}
            <img src="/static/img/1.jpg" alt="product-img" />
            {% endif %}
            <div class="overlay">{{ product.description }}</div>
          </div>
          <div class="desc">
            <span class="nama">{{ product.name }}</span>
            <span class="harga">{{ product.price }}</span>
            <p>{{ product.umkm_user_id.username }}</p>
            <span>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
                class="svg-20"
              >
                <path
                  fill-rule="evenodd"
                  d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434 2.082-5.005Z"
                  clip-rule="evenodd"
                />
              </svg>
              {{ product.rating }} | {{ product.sold }} terjual
            </span>
            <div class="btn-container">
              <a href="{% url 'edit_product' product.pk %}" class="edit-btn"
                >Edit</a
              >
              <a href="{% url 'delete_product' product.pk %}" class="delete-btn"
                >Hapus</a
              >
              <a href="{% url 'product_detail' product.pk %}" class="detail-btn"
                >Detail</a
              >
            </div>
          </div>
        </div>
        {% empty %}
        <p class="no-products">Belum ada produk yang tersedia.</p>
        {% endfor %}
      </div>
    </div>

    <!-- UMKM ANALYTICAL DASHBOARD -->
    <div class="dashboard">
      <h2>Analisis UMKM</h2>
      <div class="metrics">
        <div class="metric-card">
          <h3>Total Produk</h3>
          <p>{{ dashboard.total_products }}</p>
        </div>
        <div class="metric-card">
          <h3>Total Penjualan</h3>
          <p>{{ dashboard.total_sales }}</p>
        </div>
        <div class="metric-card">
          <h3>Total Pendapatan</h3>
          <p>Rp{{ dashboard.total_revenue|floatformat:2 }}</p>
        </div>
        <div class="metric-card">
          <h3>Rata-rata Rating</h3>
          <p>{{ dashboard.average_rating }}</p>
        </div>
      </div>

      <canvas id="topProductsChart" width="400" height="200"></canvas>
      {% if user.is_umkm and dashboard.top_products %} {{
      dashboard.top_products|json_script:"top-products-data" }} {% endif %}
    </div>
    {% else %}
    <!-- CUSTOMER ANALYTICAL DASHBOARD -->
    <div class="dashboard">
      <h2>Aktivitas Belanja Saya</h2>
      <div class="metrics">
        <div class="metric-card">
          <h3>Total Pesanan</h3>
          <p>{{ dashboard.total_orders }}</p>
        </div>
        <div class="metric-card">
          <h3>Total Barang Dibeli</h3>
          <p>{{ dashboard.total_items }}</p>
        </div>
        <div class="metric-card">
          <h3>Total Pengeluaran</h3>
          <p>Rp{{ dashboard.total_spent|floatformat:2 }}</p>
        </div>
        <div class="metric-card">
          <h3>Kategori Favorit</h3>
          <p>{{ dashboard.favorite_category }}</p>
        </div>
      </div>
    </div>
    {% endif %}

    <a href="/logout" class="logout-btn"
      >Logout<svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
        class="svg-20"
      >
        <path
          fill-rule="evenodd"
          d="M7.5 3.75A1.5 1.5 0 0 0 6 5.25v13.5a1.5 1.5 0 0 0 1.5 1.5h6a1.5 1.5 0 0 0 1.5-1.5V15a.75.75 0 0 1 1.5 0v3.75a3 3 0 0 1-3 3h-6a3 3 0 0 1-3-3V5.25a3 3 0 0 1 3-3h6a3 3 0 0 1 3 3V9A.75.75 0 0 1 15 9V5.25a1.5 1.5 0 0 0-1.5-1.5h-6Zm10.72 4.72a.75.75 0 0 1 1.06 0l3 3a.75.75 0 0 1 0 1.06l-3 3a.75.75 0 1 1-1.06-1.06l1.72-1.72H9a.75.75 0 0 1 0-1.5h10.94l-1.72-1.72a.75.75 0 0 1 0-1.06Z"
          clip-rule="evenodd"
        />
      </svg>
    </a>

    <!-- EDIT USER PROFILE -->
    <div class="edit-profile hidden">
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <i class="fa-solid fa-xmark"></i>
        <span>Ubah Profil</span>
        <div class="main-details">
          <div class="img-box">
            {% if product.image %} {% if form.instance.image %}
            <img src="{{ form.instance.image.url }}" alt="product-img" />
            {% else %}
            <img src="/static/img/1.jpg" alt="default-img" />
            {% endif %} {% else %}
            <img src="/static/img/1.jpg" alt="{{ product.name }}" />
            {% endif %}
            <label for="profile_image">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-12.15 12.15a5.25 5.25 0 0 0-1.32 2.214l-.8 2.685a.75.75 0 0 0 .933.933l2.685-.8a5.25 5.25 0 0 0 2.214-1.32L19.513 8.2Z"
                />
              </svg>
              <input
                type="file"
                id="profile_image"
                name="profile_image"
                autocomplete="off"
              />
            </label>
          </div>
          <div class="inputs">
            <div class="input-box">
              {{ form.username.label_tag }} {{ form.username }}
            </div>
            <div class="input-box">
              {{ form.email.label_tag }} {{ form.email }}
            </div>
            <div class="input-box">
              {{ form.phone_number.label_tag }} {{ form.phone_number }}
            </div>
            <div class="input-box">
              <label for="input_status">Status</label>
              <select
                name="user_status"
                id="input_status"
                class="custom-select"
              >
                <option
                  value="active"
                  {%
                  if
                  user.user_status=""
                  ="active"
                  %}selected{%
                  endif
                  %}
                >
                  Active
                </option>
                <option
                  value="inactive"
                  {%
                  if
                  user.user_status=""
                  ="inactive"
                  %}selected{%
                  endif
                  %}
                >
                  Inactive
                </option>
                <option
                  value="suspended"
                  {%
                  if
                  user.user_status=""
                  ="suspended"
                  %}selected{%
                  endif
                  %}
                >
                  Suspended
                </option>
              </select>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
                class="svg-20"
              >
                <path
                  fill-rule="evenodd"
                  d="M12.53 16.28a.75.75 0 0 1-1.06 0l-7.5-7.5a.75.75 0 0 1 1.06-1.06L12 14.69l6.97-6.97a.75.75 0 1 1 1.06 1.06l-7.5 7.5Z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
          </div>
          <div class="desc-box">
            {{ form.description.label_tag }} {{ form.description }}
          </div>
        </div>
        <button id="saveBtn" type="submit">Simpan</button>
      </form>
    </div>
  </article>
</section>
{% endblock %} {% block script %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    /* CANVAS
      const canvas = document.querySelector("#topProductsChart");
      const jsonEl = document.querySelector("#top-products-data");

      console.log("TEST!!!");
      console.log(canvas, jsonEl);

      if (!canvas || !jsonEl) return;

      const topProducts = JSON.parse(jsonEl.textContent);

      if (!Array.isArray(topProducts) || topProducts.length === 0) {
        console.log("No top products data available.");
        return;
      }

      const labels = topProducts.map((item) => item.name);
      const quantities = topProducts.map((item) => item.sold);

      new Chart(canvas.getContext("2d"), {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "Total Terjual",
              data: quantities,
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true },
          },
        },
      });
    */

    /* EDIT PROFILE */
    const editProfileForm = document.querySelector(".edit-profile");
    const exitForm = document.querySelector(".edit-profile i");
    const editButton = document.querySelector("#editBtn");
    const saveButton = document.querySelector("#saveBtn");

    if (!editButton || !saveButton || !editProfileForm) return;

    const toggleEditFormVisibility = (e) => {
      editProfileForm.classList.toggle("hidden");
    };

    window.addEventListener("click", (e) => {
      if (
        e.target === exitForm ||
        e.target === saveButton ||
        e.target === editButton ||
        (e.target === editProfileForm &&
          e.target !== editProfileForm.querySelector("form"))
      ) {
        editProfileForm.classList.toggle("hidden");
      }
    });

    const profileImagePreview = document.querySelector(
      ".edit-profile .img-box img",
    );
    const inputProfileImage = document.querySelector("#profile_image");
    const profileImage = document.querySelector(".details .img-box img");

    inputProfileImage.addEventListener("change", function () {
      const file = this.files[0];

      if (!file) {
        profileImagePreview.src = "";
        profileImagePreview.style.display = "none";
        return;
      }

      if (!file.type.startsWith("image/")) {
        alert("Please select a valid image file.");
        this.value = "";
        profileImagePreview.src = "";
        profileImagePreview.style.display = "none";
        return;
      }

      const objectURL = URL.createObjectURL(file);

      profileImagePreview.src = objectURL;
      profileImagePreview.style.display = "block";

      profileImagePreview.onload = () => {
        URL.revokeObjectURL(objectURL);
      };

      profileImagePreview.onerror = () => {
        profileImagePreview.src = "";
        profileImagePreview.style.display = "none";
        alert("Failed to load the selected image.");
      };
    });

    const inputs = document.querySelectorAll(".input-box > input");

    /* INPUTS */
    const MAX_LENGTHS = {
      username: 10,
      email: 30,
      phone_number: 13,
      password1: 12,
      password2: 12,
      description: 150,
    };

    const validators = {
      username: (value) =>
        value.length <= MAX_LENGTHS.username ||
        `Maksimal ${MAX_LENGTHS.username} karakter`,
      email: (value) =>
        value.includes("@") && value.length <= MAX_LENGTHS.email
          ? true
          : `Email harus valid dan maksimal ${MAX_LENGTHS.email} karakter`,
      phone_number: (value) =>
        (value.length <= MAX_LENGTHS.phone_number && /^\d+$/.test(value)) ||
        "Nomor telepon harus berupa angka",
      password: (value) =>
        value.length <= MAX_LENGTHS.password ||
        `Maksimal ${MAX_LENGTHS.password} karakter`,
      description: (value) =>
        value.length <= MAX_LENGTHS.description ||
        `Maksimal ${MAX_LENGTHS.description} karakter`,
    };

    const validateInput = (input) => {
      const fieldName = input.id.replace("input_", "");
      const value = input.value.trim();
      const validator = validators[fieldName];

      if (validator) {
        const result = validator(value);
        if (result !== true) {
          input.setCustomValidity(result);
          input.reportValidity();
          return false;
        } else {
          input.setCustomValidity("");
          return true;
        }
      }
      return true;
    };

    inputs.forEach((input) => {
      input.addEventListener("input", () => {
        const field = input.id.replace("input_", "");
        const maxLength = MAX_LENGTHS[field];
        if (maxLength && input.value.length > maxLength) {
          input.value = input.value.slice(0, maxLength);
        }
      });

      input.addEventListener("blur", () => {
        validateInput(input);
      });
    });

    const inputUsername = document.querySelector("#input_username");
    const inputEmail = document.querySelector("#input_email");
    const inputPhoneNumber = document.querySelector("#input_phone_number");
    const inputUserStatus = document.querySelector("#input_status");
    const inputUserDescription = document.querySelector("#input_description");

    const lblUsername = document.querySelector("#lblUsername");
    const lblEmail = document.querySelector("#lblEmail");
    const lblPhone = document.querySelector("#lblPhone");
    const lblStatus = document.querySelector("#lblStatus");
    const lblDescription = document.querySelector("#lblDescription");

    const form = document.querySelector(".edit-profile form");
    form.addEventListener("submit", () => {
      profileImage.src = profileImagePreview.src || "/static/img/1.jpg";
      lblUsername.textContent = inputUsername.value;
      lblEmail.textContent = inputEmail.value;
      lblPhone.textContent = inputPhoneNumber.value;
      lblStatus.textContent = inputUserStatus.value;
      lblDescription.textContent = inputUserDescription.value;
    });

    /* HARGA */
    const productPrices = document.querySelectorAll(".harga");
    productPrices.forEach((productPrice) => {
      const productPriceValue = productPrice.textContent;
      const formattedPrice = new Intl.NumberFormat("id-ID", {
        style: "currency",
        currency: "IDR",
        minimumFractionDigits: 0,
      }).format(parseFloat(productPriceValue.replace(/[^0-9.-]+/g, "")));
      productPrice.textContent = formattedPrice;
    });
  });
</script>
{% endblock %}
