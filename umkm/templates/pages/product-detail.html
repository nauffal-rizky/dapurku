{% extends '../layout/base.html' %} {% load static %} {% block content %}
<section class="detail-product">
  <div class="content">
    <a href="{% url 'products' %}" class="back-btn">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
        class="svg-25"
      >
        <path
          fill-rule="evenodd"
          d="M7.28 7.72a.75.75 0 0 1 0 1.06l-2.47 2.47H21a.75.75 0 0 1 0 1.5H4.81l2.47 2.47a.75.75 0 1 1-1.06 1.06l-3.75-3.75a.75.75 0 0 1 0-1.06l3.75-3.75a.75.75 0 0 1 1.06 0Z"
          clip-rule="evenodd"
        />
      </svg>
      Kembali ke halaman depan</a
    >

    <div class="detail-content">
      <div class="product-information">
        <div class="image-container">
          {% if product.image %}
          <img src="{{ product.image.url }}" alt="{{ product.name }}" />
          {% else %}
          <img src="{% static '/img/1.jpg' %}" alt="default image" />
          {% endif %}

          <div class="overlays">
            {% for i in "123456" %} {% if product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}" />
            {% else %}
            <img src="{% static '/img/1.jpg' %}" alt="default image" />
            {% endif %} {% endfor %}
          </div>
        </div>
        <div class="desc">
          <div class="head">
            <span>
              {{ product.name }} |
              <a href="{% url 'umkm_profile' product.umkm_user_id.id %}">
                {{ product.umkm_user_id.username }}
              </a>
            </span>

            <p>
              Terjual <span>{{ soldProducts.stock }}</span> |
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
                class="svg-20"
              >
                <path
                  fill-rule="evenodd"
                  d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434 2.082-5.005Z"
                  clip-rule="evenodd"
                />
              </svg>
              <span>5</span><span>(166 Rating)</span>
            </p>
          </div>
          <span class="category"
            >Kategori: <span>{{ product.category }}</span></span
          >
          <span class="price">Rp{{ product.price }}</span>

          <div class="line"></div>

          <!-- === VARIANTS === -->
          {% if product.variants.exists %}
          <div class="variants">
            <span
              >Pilih varian produk:
              <span class="underline-text"
                >{{ product.variants.first.name }}</span
              ></span
            >
            <div class="variant-container">
              {% for variant in product.variants.all %}
              <span class="{% if forloop.first %}active{% endif %}"
                >{{ variant.name }}</span
              >
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <p class="description">{{ product.description }}</p>
        </div>
        <div class="checkout">
          <span>Atur jumlah dan catatan</span>
          <p>{{ product.name }}</p>

          <div class="line"></div>

          <div class="product-amount">
            {% if product.umkm_user_id.username != user.username %}
            <div class="counter">
              <button type="button" class="decrease-btn">-</button>
              <input type="text" maxlength="3" value="0" required />
              <button type="button" class="increase-btn">+</button>
            </div>
            {% endif %}
            <span class="stock">
              Stok: <span>Sisa {{ product.stock }}</span>
            </span>
          </div>

          {% if product.umkm_user_id.username != user.username %}
          <div class="total">
            <span class="subTotal">Subtotal</span>
            <span>Rp0</span>
          </div>

          <form method="POST" action="{% url 'add_to_cart' product.id %}">
            {% csrf_token %}

            <!-- hidden variant (kalau ada) -->
            {% if product.variants.exists %}
            <input
              type="hidden"
              name="variant_id"
              id="variant_id"
              value="{{ product.variants.first.id }}"
            />
            {% endif %}

            <!-- hidden quantity -->
            <input type="hidden" name="quantity" id="quantity" value="1" />

            <div class="btns">
              <button type="submit" class="active">+ Keranjang</button>
              <a href="{% url 'order' %}">Beli</a>
            </div>
          </form>
          {% endif %}
        </div>
      </div>

      <div class="umkm-products">
        <h2 class="underline-text">
          Produk {{ product.umkm_user_id.username }}
        </h2>
        <div class="product-list">
          {% for item in umkmProducts %}
          <a href="{% url 'product_detail' item.pk %}" class="product-item">
            <span class="category {{ item.category }}"
              >{{ item.category }}</span
            >
            <div class="image">
              {% if item.image %}
              <img src="{{ item.image.url }}" alt="{{ item.name }}" />
              {% else %}
              <img src="{% static '/img/1.jpg' %}" alt="default image" />
              {% endif %}
              <div class="overlay">{{ item.description }}</div>
            </div>
            <div class="desc">
              <span class="nama">{{ item.name }}</span>
              <span class="harga">Rp{{ item.price }}</span>
              <p>{{ item.umkm_user_id.username }}</p>
              <span><i class="fa-solid fa-star"></i> 5 | 100+ terjual</span>
            </div>
          </a>
          {% empty %}
          <p class="no-products">Tidak ada produk UMKM yang tersedia.</p>
          {% endfor %}
        </div>
      </div>

      <div class="other-products">
        <h2 class="underline-text">Produk Lainnya</h2>
        <div class="product-list">
          {% for item in otherProducts %}
          <a href="{% url 'product_detail' item.pk %}" class="product-item">
            <span class="category {{ item.category }}"
              >{{ item.category }}</span
            >
            <div class="image">
              {% if item.image %}
              <img src="{{ item.image.url }}" alt="{{ item.name }}" />
              {% else %}
              <img src="{% static '/img/1.jpg' %}" alt="default image" />
              {% endif %}
              <div class="overlay">{{ item.description }}</div>
            </div>
            <div class="desc">
              <span class="nama">{{ item.name }}</span>
              <span class="harga">Rp{{ item.price }}</span>
              <p>{{ item.umkm_user_id.username }}</p>
              <span><i class="fa-solid fa-star"></i> 5 | 100+ terjual</span>
            </div>
          </a>
          {% empty %}
          <p class="no-products">Tidak ada produk lainnya yang tersedia.</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %} {% block script %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const overlays = document.querySelectorAll(".overlays img");
    const activeImage = document.querySelector(".image-container > img");

    overlays.forEach((overlay) => {
      overlay.addEventListener("click", () => {
        activeImage.src = overlay.src;
        activeImage.alt = overlay.alt;
        overlays.forEach((img) => img.classList.remove("active"));
        overlay.classList.add("active");
      });
    });

    const variantContainer = document.querySelector(".variant-container");
    if (variantContainer) {
      const lblVariant =
        variantContainer.previousElementSibling.querySelector("span");
      let activeVariantValue =
        variantContainer.querySelector(".active")?.textContent.trim() || "";
      lblVariant.textContent = activeVariantValue;

      variantContainer.querySelectorAll("span").forEach((variant) => {
        variant.addEventListener("click", () => {
          variantContainer
            .querySelectorAll("span")
            .forEach((v) => v.classList.remove("active"));
          variant.classList.add("active");
          lblVariant.textContent = variant.textContent.trim();
        });
      });
    }

    const price = document.querySelector(".price");
    const subTotal = document.querySelector(".subTotal");
    const counterInput = document.querySelector(".counter input");
    const increaseBtn = document.querySelector(".increase-btn");
    const decreaseBtn = document.querySelector(".decrease-btn");

    const product = {
      price: price.textContent,
      stock:
        parseInt(
          document
            .querySelector(".stock span:last-child")
            .textContent.replace("Sisa ", ""),
        ) || 0,
    };

    const updateTotal = () => {
      const total = document.querySelector(".total span:last-child");
      const quantity = parseInt(counterInput.value) || 0;
      const priceValue = parseInt(
        product.price.replace("Rp", "").replace(/\./g, ""),
      );
      total.textContent =
        quantity > 0
          ? `Rp${(quantity * priceValue).toLocaleString("id-ID")}`
          : "Rp0";
    };

    if (counterInput && increaseBtn && decreaseBtn) {
      counterInput.addEventListener("input", () => {
        counterInput.value = counterInput.value.replace(/\D/g, "");
        let value = parseInt(counterInput.value) || 0;
        if (value > product.stock) counterInput.value = product.stock;
        updateTotal();
      });

      increaseBtn.addEventListener("click", () => {
        let value = parseInt(counterInput.value) || 0;
        if (value < product.stock) counterInput.value = value + 1;
        updateTotal();
      });

      decreaseBtn.addEventListener("click", () => {
        let value = parseInt(counterInput.value) || 0;
        if (value > 0) counterInput.value = value - 1;
        updateTotal();
      });
    }

    const form = document.querySelector('form[action*="add_to_cart"]');
    const quantityField = document.querySelector('input[name="quantity"]');

    if (form && quantityField && counterInput) {
      form.addEventListener("submit", () => {
        quantityField.value = counterInput.value || 1;
      });
    }

    const formattedPrice = parseInt(
      price.textContent.replace("Rp", "").replace(".00", ""),
    ).toLocaleString("id-ID");
    price.textContent = `Rp ${formattedPrice}`;
  });
</script>
{% endblock %}
